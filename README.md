# SPIRAL3D:Structured Perception to Intelligent Reasoning And Logic in 3D

## 快速开始
环境：Python 3.10+，依赖仅 `numpy`。
```bash
pip install numpy
python main.py --output output --num-samples 3 --points 4096 --seed 0
## 模式与参数
- `--mode` 可选：
  - 主集合：`main`
  - 大类：`r1-only`, `r2-only`, `r3-only`
  - 消融：`all-minus-r1`, `all-minus-r2`, `all-minus-r3`
- `--rules` 自定义规则列表（逗号分隔，如 `R1-1,R2-7,R3-2`，会覆盖 `--mode`）
  - 仅从给定规则编号中采样题目，编号不区分大小写，非法编号会直接报错提示可选列表。
  - 示例：`python main.py --num-samples 5 --rules R1-1,R2-7,R3-2 --points 4096`
- 规则采样：当前对可用规则等概率随机采样（`--simple-prob / --medium-prob / --complex-prob` 已弃用）。
- 其他：`--output`, `--num-samples`, `--points`, `--seed`。
示例：`python main.py --num-samples 10 --mode r2-only --points 4096`
- 默认每帧点数 `--points=4096`，写入 PLY 时固定颜色：1=红，2=绿，3=蓝，4=紫，5=白，6=橙（同一文件内所有点同色）。
```
生成目录示例：
```
output/sample_000000/
    1.ply  # A
    2.ply  # B
    3.ply  # 候选 A
    4.ply  # 候选 B
    5.ply  # 候选 C
    6.ply  # 候选 D
    meta.json  # 含文件路径、正确选项、rule_meta
output/meta.json  # 所有题目的 meta 列表
```
点云文件固定颜色（每个文件内所有点相同）：1=深海蓝(31,119,180)，2=鲜亮橙(255,127,14)，3=森林绿(44,160,44)，4=砖红(214,39,40)，5=柔和紫(148,103,189)，6=可可棕(140,86,75)。

基础属性：形状，尺度，位置，姿态，密度
R1（点级，属性解耦推理）：聚焦于单属性的变化，代表了图节点
R2（边级，几何交互推理）：聚焦于属性之间的共同作用，代表了图边
R3（子图级，结构组合推理）：聚焦于固定几何构型，代表了子图
R4（全局图，因果动力推理）：聚焦于不固定的子图模型结构，引入结构推演与世界规则，代表了全局图
R1: 属性解耦推理
- 认知视角： 固有属性感知
  - 描述： 就像人类婴儿首先学会识别“红色”、“圆形”一样，模型首先必须具备高保真的特征解耦能力。它需要从杂乱的 3D 点云中准确提取出每个物体的独立物理属性，不受环境干扰。
- 图论视角： 节点嵌入精炼
  - 定义： 给定图  $$G=(V, E)$$，R1 考察模型近似一元函数  $$f(v_i)$$的能力，目标是最小化属性预测误差  $$\mathcal{L}_{R1} = \sum || \hat{y}_{attr} - f(v_i) ||$$
Insight：强调是从非结构化的 Raw Point Cloud 到结构化的 Graph Node 的特征提取过程，这本身就是 3D 视觉的一大难点。
R2: 几何交互推理
- 认知视角： 关系推理
  - 描述： 认知升级。模型从关注点扩展到关注线，必须理解物体间的空间拓扑（如包含、相邻）和度量关系（如距离、角度），建立场景的空间语境。
- 图论视角： 边消息传递
  - 定义： R2 考察模型近似二元函数  $$g(v_i, v_j)$$的能力，这是一个  $$O(N^2)$$的成对交互问题，模型必须准确编码边属性 $$e_{ij}$$。
Insight：强调 R2 使得模型不再是看一堆点，而是结合多个点判断点间的关系。
R3: 结构组合推理
- 认知视角： 空间结构推理
  - 描述： 真正的智力飞跃。模型不仅要看清现有的点和线，还要想象出不存在的结构。比如看到三个点，脑子里要画出一个三角形并计算面积；看到一堆乱点，要能分出 Group A 和 Group B 并找到它们的重心。这是对潜在变量的推理。
- 图论视角： 子图/超边模式识别。
  - 定义： R3 考察模型在节点子集  $$V_{sub} \subset V$$ 上提取高阶特征  $$H(V_{sub})$$的能力，涉及超边的构建。比如面积是三个节点  $$(v_1, v_2, v_3)$$共同决定的属性；对称性是整个图 $$G$$ 的全局同构属性。
Insight：聚焦于如何高效处理高阶依赖，将题目包装为抽象认知
R4: 因果动力推理（该种类题目在生成的过程中会同步生成过程解法cot）
- 认知视角： 反事实与规划
  - 描述： 涉及到认知的最高阶想象力，模型不再满足于静态观察，它开始在脑海中演化这个场景。它思考“如果……会怎样”（If... then...），并且需要对物理规律和几何约束的深刻理解。
- 图论视角： 动态图演化
  - 定义： R4 考察模型预测图状态转移的能力： $$
G_{t+1} = \mathcal{T}(G_t, \text{Action})$$。
Insight：把静态的 3D 问答提升到了图World Model的高度。

### R1 属性解耦推理
- **R1-1 等差统一缩放**：单一几何体尺寸按等差递进，连续两步的尺寸增量保持一致。
- **R1-2 固定轴旋转**：单一几何体绕固定轴等角度旋转，旋转增量在两步中不变。
- **R1-3 旋转离散循环**：单一几何体在 0°/90°/180° 等离散旋转状态间循环。
- **R1-4 固定向量平移**：单一几何体沿固定向量做等差平移，方向与步长保持一致。
- **R1-5 密度等差**：单一几何体密度按等差变化，增量恒定。
- **R1-6 形状变化继承**：单一几何体形状连续变化，A→B 后继续变化为 C（每帧都发生形状替换）。
- **R1-7 复合位姿缩放**：单一几何体每步同时进行固定倍率缩放与固定角度旋转，复合变化连续延续。
- **R1-8 主轴对齐位移**：单一几何体每步沿自身主轴方向移动，位移方向与主轴对齐。
- **R1-9 密度驱动缩放**：两几何体密度固定且不同，尺寸按密度大小分配不同缩放倍率，密度更高者变化更强。
- **R1-10 距离尺寸倒数**：三几何体以一者为锚点，其他两者尺寸变化与到锚点距离成反比，近者变化更强（统一增或减）。
- **R1-11 几何个数变化**：按形状类别计数做等差增长，各类别数量按固定步长递增。

### R2 几何交互推理
- **R2-1 质心守恒缩放**：多几何体整体缩放并伴随平移，使参与集合的质心在各帧保持不变。
- **R2-2 双对象守恒**：两几何体尺寸之和保持常数，一增一减且变化量一致。
- **R2-3 属性互换联动**：两几何体在相邻帧交替交换“尺寸/姿态”，先交换一个属性再交换另一个。
- **R2-4 距离密度倒数**：三几何体中以一者为锚点，其他两者密度变化与距离成反比，近者变化更强（统一增或减）。
- **R2-5 成对距离等比**：两几何体间距按固定比例等比变化，比例在连续两步一致。
- **R2-6 各向异性等比拉伸**：单一几何体沿某一轴放大 k，其他轴按 $1/\sqrt{k}$ 缩放以保持体积不变。
- **R2-7 方向旋转等差**：对象间方向向量以固定角度等差旋转，同时两者距离保持恒定。
- **R2-8 包含比例等差**：内含/覆盖比例在 (0,1) 内按固定增量等差变化。
- **R2-9 夹角等差**：两几何体主轴夹角按等差规律变化。
- **R2-10 相对姿态保持**：多几何体共同旋转同一角度，彼此相对姿态保持不变。
- **R2-11 加速旋转**：旋转幅度逐帧加速，第二步旋转角度是第一步的两倍。
- **R2-12 行星公转**：多个对象围绕中心体公转，不同对象角速度不同但在各帧保持一致。
- **R2-13 易位姿态转换**：姿态变化跟随“形状身份”延续（形状交换位置时，姿态演化随形状而非位置）。
- **R2-14 易位尺寸转换**：尺寸变化跟随“形状身份”延续，而不是跟随空间位置。
- **R2-15 易位密度转换**：密度变化跟随“形状身份”延续，而不是跟随空间位置。
- **R2-16 尺度轴置换循环**：$$r_x,r_y,r_z$$ 按固定置换顺序循环轮转。

### R3 结构组合推理
- **R3-1 螺旋上升**：多几何体围绕中心按固定角度步长旋转上升，高度按等差递增。
- **R3-2 排序模式循环**：按 x 轴排序得到的对象序列在固定置换之间循环。
- **R3-3 直线阵型旋转**：6 个几何体线性排列，整体绕中心以固定角度旋转并延续。
- **R3-4 密度循环吞噬**：6 个几何体固定在正六边形位置，密度更大的对象若有更小密度邻居即为吞噬主体；每帧按顺/逆时针仅吞噬一个相邻对象，吞噬主体不被吞，数量递减。
- **R3-5 尺寸循环吞噬**：规则同 R3-4，但以尺寸大小决定吞噬主体，位置保持不重排。
- **R3-6 多对象姿态变化**：3–6 个几何体姿态按空间位置索引延续变化，同一位置的姿态变化方向与幅度保持一致。
- **R3-7 多对象位置轮换**：球体位于三角形/五边形顶点，按步长与方向在顶点间轮换，允许叠加轻微帧间旋转。
- **R3-8 多对象密度变化**：密度沿固定位置序列单调增减，结构可为直线/三角形/矩形/五边形。
- **R3-9 多对象尺度变化**：尺寸沿固定位置序列单调增减，结构可为直线/三角形/矩形/五边形。
- **R3-10 多对象形状变化**：形状沿固定位置序列按规则转换，结构可为直线/三角形/矩形/五角星。
- **R3-11 正弦位置转换**：对象位置沿正弦采样点滑动，连续帧在相邻采样点间平移（0°/45°方向）。

### R4 因果动力推理
- **R4-1 跳步预测**：从可外推的一阶规则中抽取（如缩放/旋转/平移/密度等差），给定前两帧直接推断下下帧（跳过一帧）。
- **R4-2 节点分裂演化**：每帧所有对象一分为二，体积减半，形状/密度保持，姿态随机扰动。
- **R4-3 节点融合演化**：每帧同形状对象两两融合为一体，体积相加，形状/密度保持，姿态随机扰动。
- **R4-4 几何阵型演化**：初始为六边形阵型，之后每帧边数减少 1，阵型在直线/三角形/矩形/五角星/六边形之间切换。
- **R4-5 接触式属性传染**：大尺寸对象向小尺寸对象传染尺寸/密度/姿态中的 0–3 项；传染从第二帧开始，每轮后新增 2 个随机对象。
- **R4-6 进阶行星公转**：三对象公转系统，中心按半径序相邻者中“尺寸更大者”切换；其余对象围绕当前中心以各自角速度旋转。
- **R4-7 对称转换**：左右镜像对象的移动与旋转呈镜像反向同步。
- **R4-8 阻尼弹跳**：弹跳高度按固定衰减比例递减，每帧记录弹跳最高点。
- **R4-9 软体挤压**：底部球体受上方对象挤压产生形变，形变程度随外部对象数量/尺寸变化而改变。
- **R4-10 多米诺骨牌**：同形立方体依次倾倒，倾斜角与倒下状态沿链条逐帧传播。
