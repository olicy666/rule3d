# SPIRAL3D:Structured Perception to Intelligent Reasoning And Logic in 3D

## 快速开始
环境：Python 3.10+，依赖仅 `numpy`。
```bash
pip install numpy
python main.py --output output --num-samples 3 --points 4096 --seed 0
## 模式与参数
- `--mode` 可选：
  - 主集合：`main`
  - 大类：`r1-only`, `r2-only`, `r3-only`
  - 消融：`all-minus-r1`, `all-minus-r2`, `all-minus-r3`
- `--rules` 自定义规则列表（逗号分隔，如 `R1-1,R2-7,R3-2`，会覆盖 `--mode`）
  - 仅从给定规则编号中采样题目，编号不区分大小写，非法编号会直接报错提示可选列表。
  - 示例：`python main.py --num-samples 5 --rules R1-1,R2-7,R3-2 --points 4096`
- 规则采样：当前对可用规则等概率随机采样（`--simple-prob / --medium-prob / --complex-prob` 已弃用）。
- 其他：`--output`, `--num-samples`, `--points`, `--seed`。
示例：`python main.py --num-samples 10 --mode r2-only --points 4096`
- 默认每帧点数 `--points=4096`，写入 PLY 时固定颜色：1=红，2=绿，3=蓝，4=紫，5=白，6=橙（同一文件内所有点同色）。
```
生成目录示例：
```
output/sample_000000/
    1.ply  # A
    2.ply  # B
    3.ply  # 候选 A
    4.ply  # 候选 B
    5.ply  # 候选 C
    6.ply  # 候选 D
    meta.json  # 含文件路径、正确选项、rule_meta
output/meta.json  # 所有题目的 meta 列表
```
点云文件固定颜色（每个文件内所有点相同）：1=深海蓝(31,119,180)，2=鲜亮橙(255,127,14)，3=森林绿(44,160,44)，4=砖红(214,39,40)，5=柔和紫(148,103,189)，6=可可棕(140,86,75)。

基础属性：形状，尺度，位置，姿态，密度
R1（点级，属性解耦推理）：聚焦于单属性的变化，代表了图节点
R2（边级，几何交互推理）：聚焦于属性之间的共同作用，代表了图边
R3（子图级，结构组合推理）：聚焦于固定几何构型，代表了子图
R4（全局图，因果动力推理）：聚焦于不固定的子图模型结构，引入结构推演与世界规则，代表了全局图
R1: 属性解耦推理
- 认知视角： 固有属性感知
  - 描述： 就像人类婴儿首先学会识别“红色”、“圆形”一样，模型首先必须具备高保真的特征解耦能力。它需要从杂乱的 3D 点云中准确提取出每个物体的独立物理属性，不受环境干扰。
- 图论视角： 节点嵌入精炼
  - 定义： 给定图  $$G=(V, E)$$，R1 考察模型近似一元函数  $$f(v_i)$$的能力，目标是最小化属性预测误差  $$\mathcal{L}_{R1} = \sum || \hat{y}_{attr} - f(v_i) ||$$
Insight：强调是从非结构化的 Raw Point Cloud 到结构化的 Graph Node 的特征提取过程，这本身就是 3D 视觉的一大难点。
R2: 几何交互推理
- 认知视角： 关系推理
  - 描述： 认知升级。模型从关注点扩展到关注线，必须理解物体间的空间拓扑（如包含、相邻）和度量关系（如距离、角度），建立场景的空间语境。
- 图论视角： 边消息传递
  - 定义： R2 考察模型近似二元函数  $$g(v_i, v_j)$$的能力，这是一个  $$O(N^2)$$的成对交互问题，模型必须准确编码边属性 $$e_{ij}$$。
Insight：强调 R2 使得模型不再是看一堆点，而是结合多个点判断点间的关系。
R3: 结构组合推理
- 认知视角： 空间结构推理
  - 描述： 真正的智力飞跃。模型不仅要看清现有的点和线，还要想象出不存在的结构。比如看到三个点，脑子里要画出一个三角形并计算面积；看到一堆乱点，要能分出 Group A 和 Group B 并找到它们的重心。这是对潜在变量的推理。
- 图论视角： 子图/超边模式识别。
  - 定义： R3 考察模型在节点子集  $$V_{sub} \subset V$$ 上提取高阶特征  $$H(V_{sub})$$的能力，涉及超边的构建。比如面积是三个节点  $$(v_1, v_2, v_3)$$共同决定的属性；对称性是整个图 $$G$$ 的全局同构属性。
Insight：聚焦于如何高效处理高阶依赖，将题目包装为抽象认知
R4: 因果动力推理（该种类题目在生成的过程中会同步生成过程解法cot）
- 认知视角： 反事实与规划
  - 描述： 涉及到认知的最高阶想象力，模型不再满足于静态观察，它开始在脑海中演化这个场景。它思考“如果……会怎样”（If... then...），并且需要对物理规律和几何约束的深刻理解。
- 图论视角： 动态图演化
  - 定义： R4 考察模型预测图状态转移的能力： $$
G_{t+1} = \mathcal{T}(G_t, \text{Action})$$。
Insight：把静态的 3D 问答提升到了图World Model的高度。

### R1 属性解耦推理
- **R1-1 等差统一缩放**：规则：单一几何体整体尺寸按等差递进，比例对所有轴一致，连贯三帧的尺寸差值相同。解题：测量每帧体积/半径差值，验证等差后按同样增量或减量推到下一帧；异常噪声可用中值平滑。
- **R1-2 固定轴旋转**：规则：绕稳定的世界/物体坐标轴做等角度旋转，轴方向不漂移。解题：先用向量叉积或 PCA 确定转轴，再求连续帧欧拉角差或四元数差，保持符号与步长继续旋转。
- **R1-3 旋转离散循环**：规则：姿态只落在有限离散集（如 0/90/180/270），按固定顺序循环。解题：枚举已见姿态集合，确定循环长度与方向（顺/逆），在序列上取下一位置。
- **R1-4 固定向量平移**：规则：几何体质心沿单一固定向量做等差平移，方向与步长恒定且无旋转耦合。解题：计算两帧质心差得位移向量，验证第三帧差一致后再平移同向同幅。
- **R1-5 密度等差**：规则：点云密度（或点数）按固定增量线性变化，几何姿态与尺寸不受影响。解题：统计每帧点数/体素占用，核对差值恒定，再用同增量外推；若超上下界需截断到物理可行范围。
- **R1-6 形状变化继承**：规则：形状按“替换链”逐帧演化（如 cube→cylinder→cone），每一步完全替换前一形状。解题：找到已出现的形状序列与方向，若首尾重复则视为循环，否则延长链条并输出下一形状。
- **R1-7 复合位姿缩放**：规则：单体同步发生等比缩放与等角旋转，二者步长固定且相互独立。解题：分别估计缩放倍率 s 与旋转角 Δθ，下一帧执行 scale*s 与 rotate+Δθ，注意保持旋转方向一致。
- **R1-8 主轴对齐位移**：规则：物体沿自身主轴正/反向平移，位移方向始终与当前主轴平行。解题：用 PCA 找主轴向量 n，取质心差投影到 n 得步长，按同符号与幅度沿 n 继续移动。
- **R1-9 密度驱动缩放**：规则：两体密度固定但不同，尺寸变化幅度与密度成正比（密度大者缩放更剧烈），方向一致。解题：计算两者缩放倍率比值与密度比是否一致，保持映射比例外推下一步。
- **R1-10 距离尺寸倒数**：规则：以一体为锚，另两体的尺寸变化幅度与到锚点距离成反比，变化方向相同。解题：先确定锚点（距离关系稳定者），用距离比求变化幅度比，保持反比例系数继续更新尺寸。
- **R1-11 几何个数变化**：规则：按形状类别计数做等差增长或减少，每类步长可不同但帧间恒定。解题：对每种形状求计数差，验证恒定后按同差值增减，缺货时保持不为负。

### R2 几何交互推理
- **R2-1 质心守恒缩放**：规则：一组物体共同缩放+平移，但整体质心固定。解题：先求多体质心，验证跨帧不变；估计统一缩放系数 s 与平移 t，使新质心仍为原点，下一帧应用同 s 与 t。
- **R2-2 双对象守恒**：规则：两体尺寸之和恒定，一增一减且幅度相等。解题：检查尺寸和是否恒定，取增量 Δ，下一帧将一体加 Δ、另一体减 Δ；若接近零需截断并保持非负。
- **R2-3 属性互换联动**：规则：两体交替交换单个属性（尺寸/姿态），交换顺序固定。解题：列出已交换的属性顺序，保持“未交换→交换→下个属性”的节奏，将目标属性在下一帧互换。
- **R2-4 距离密度倒数**：规则：锚点固定，另两体密度变化幅度与锚点距离成反比，方向一致。解题：确认锚点后计算距离比 r，密度变化比应为 1/r，保持系数外推；方向由前两帧增减符号决定。
- **R2-5 成对距离等比**：规则：两体间距离按固定比例 p 做等比变化。解题：求 d2/d1、d3/d2 是否稳定，取 p 后下一步距离 = d3*p，方向保持当前连线。
- **R2-6 各向异性等比拉伸**：规则：沿一主轴放大 k，其余两轴按 1/√k 收缩，体积守恒。解题：用包围盒或 PCA 找主轴，测得 k，下一帧对主轴乘 k，其余轴乘 1/√k。
- **R2-7 方向旋转等差**：规则：连接向量以固定角度步长在平面内旋转，距离保持恒定。解题：提取单位方向向量，计算两步夹角 Δθ，保持长度不变旋转同 Δθ。
- **R2-8 包含比例等差**：规则：内含比例 r∈(0,1) 线性变化，可能代表重叠面积或体积占比。解题：求相邻帧 r 差值 Δr，下一步 r+Δr，超界则裁剪到 (0,1) 内。
- **R2-9 夹角等差**：规则：两体主轴夹角按等差递进。解题：用向量夹角求 Δθ，保持符号与大小外推；注意 0–180° 归一。
- **R2-10 相对姿态保持**：规则：多体整体刚体旋转，彼此相对姿态与距离不变。解题：计算任意两体方向/距离是否恒定，若是则求整体旋转矩阵 R（如用 Kabsch），下一帧应用同 R。
- **R2-11 加速旋转**：规则：旋转角度呈等比或倍增（常见为第二步=第一步×2）。解题：算出第一步 Δ1 与第二步 Δ2，估计加速因子 a=Δ2/Δ1，下一步 Δ3=Δ2*a。
- **R2-12 行星公转**：规则：多体绕中心公转，各自角速度恒定但不同，半径固定。解题：确定中心体，估计每个卫星的角速度 ωi 与半径 ri，下一帧沿各自方向旋转 ωi。
- **R2-13 易位姿态转换**：规则：姿态演化绑定“形状身份”而非位置，交换位置不改变各自姿态轨迹。解题：追踪形状 ID，读取其历史姿态增量并按同增量更新，无视其当前坐标。
- **R2-14 易位尺寸转换**：规则：尺寸演化跟随身份，位置交换不影响尺寸轨迹。解题：绑定 ID→尺寸序列，按各自等差/等比外推尺寸，再放到交换后的新位置。
- **R2-15 易位密度转换**：规则：密度演化跟随身份，位置交换不影响密度轨迹。解题：同上，保持 ID→密度变化模式并外推。
- **R2-16 尺度轴置换循环**：规则：rx, ry, rz 按固定置换序列循环（如 x→y→z→x）。解题：识别置换周期与方向，下一步将当前轴长重排到下一个映射。

### R3 结构组合推理
- **R3-1 螺旋上升**：规则：多体绕中心按固定角度步长公转，同时高度按等差递增，形成螺旋线。解题：求平面角步长 Δθ 和高度增量 Δh，下一帧旋转 Δθ、提升 Δh；半径若恒定需保持不变。
- **R3-2 排序模式循环**：规则：按 x 轴排序得到的序列在若干置换之间循环（如左移/右移/对调）。解题：记录最近两步的置换映射，识别循环长度，套用下一置换再重排对象。
- **R3-3 直线阵型旋转**：规则：6 体等距排成直线，整体围绕中心点做等角度旋转，内间距不变。解题：验证内距恒定，求整体旋转角 Δθ，下一帧对所有点绕中心旋转 Δθ。
- **R3-4 密度循环吞噬**：规则：6 体固定正六边形顶点，密度最大的且邻边存在更低密度者成为吞噬者；按顺/逆时针每帧吞噬一个相邻体，被吞者移除、位置不重排。解题：确定方向后选择吞噬者和目标，删除目标，保留剩余顶点顺序。
- **R3-5 尺寸循环吞噬**：规则同上，但以尺寸最大者为吞噬主体。解题：比较尺寸确定主体，沿既定方向吞噬相邻一个，移除后保持顶点坐标。
- **R3-6 多对象姿态变化**：规则：3–6 体的姿态变化与空间位置绑定，每个固定位置保持相同旋转方向与步长。解题：按位置索引对齐，求该位置的旋转增量并复制到下一帧。
- **R3-7 多对象位置轮换**：规则：球体在多边形顶点按固定步长和方向轮换，可叠加轻微整体旋转。解题：识别轮换步长 k 与方向，位置索引整体向前/后平移 k，再加上统一微旋转。
- **R3-8 多对象密度变化**：规则：密度沿固定位置序列单调增或减，不受交换影响。解题：锁定位置顺序，估计单调步长（等差/等比），按序列方向外推。
- **R3-9 多对象尺度变化**：规则：尺寸沿固定位置序列单调变化，与密度同理。解题：同上，保持位置→尺度映射并延续趋势。
- **R3-10 多对象形状变化**：规则：形状沿固定位置序列按映射表轮换（如 A→B→C 循环），几何骨架不换。解题：为每位置建立形状循环表，取下一形状替换。
- **R3-11 正弦位置转换**：规则：位置沿正弦轨迹采样点依次滑动，帧间移动到相邻采样点（0°/45°方向）。解题：定位当前相位与方向，沿正弦采样表移动一步；越界则反向。

### R4 因果动力推理
- **R4-1 跳步预测**：规则：底层一阶规律已确定（缩放/旋转/平移/密度等差），题目要求直接预测 t+2 帧。解题：先用前两帧拟合一阶规律，再对第三帧虚拟外推，取 t+2 结果作为答案，确保步长未变。
- **R4-2 节点分裂演化**：规则：每帧所有对象一分为二，体积减半，形状与密度继承，姿态有小扰动。解题：复制每体为两个，尺寸缩放 0.5，姿态加微扰并分离位置以避免重合。
- **R4-3 节点融合演化**：规则：同形状对象两两融合，体积相加，形状/密度保持，姿态微扰。解题：为每种形状配对并合并到中点位置，尺寸按体积求和，数量减半。
- **R4-4 几何阵型演化**：规则：从六边形起，边数每帧减 1，阵型在直线/三角形/矩形/五角星/六边形间切换，整体尺度可保持。解题：确定当前边数 n，下一帧用 n-1 的正多边形或直线布点，保持半径或边长一致。
- **R4-5 接触式属性传染**：规则：大尺寸体向小尺寸体传染 0–3 个属性（尺寸/密度/姿态），传染从第二帧起；每轮结束新增 2 个随机对象。解题：定位最大尺寸的源，复制其指定属性到接触目标，随后在随机位置生成 2 个新体（形状/密度继承规则给出）。
- **R4-6 进阶行星公转**：规则：三体系统，中心体会在相邻半径序中选择“尺寸更大者”成为新中心；其余两体绕当前中心以各自恒定角速度旋转。解题：跟踪中心切换（按半径与尺寸判定），保持各自角速度和半径，更新位置。
- **R4-7 对称转换**：规则：左右镜像的物体运动/旋转互为镜像且符号相反，镜面通常为 yz 平面。解题：获取左体运动向量与旋转，右体取关于镜面反射并反向的向量/角度，保持镜像一致。
- **R4-8 阻尼弹跳**：规则：弹跳高度按固定衰减比例 r 递减，记录每次峰值。解题：测得前两峰值比确定 r，下一峰值乘 r 得新高度，水平位置多保持不变。
- **R4-9 软体挤压**：规则：底部球体被上方对象挤压产生扁平形变，形变量与外部压力（数量/尺寸）正相关。解题：估计总压力 P，映射到扁平化比例（如高度减、半径增），随压力变化更新形变。
- **R4-10 多米诺骨牌**：规则：等距立方体链条依次倾倒，倾斜角沿链传播，最终完全倒下。解题：识别传播方向与当前倾斜角增量，下一帧让下一个方块进入相同或更大倾斜状态，已倒者保持平躺。
